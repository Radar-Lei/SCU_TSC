---
phase: 02-max-pressure-config
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - grpo/max_pressure.py
  - grpo/__init__.py
  - grpo/config.py
autonomous: true

must_haves:
  truths:
    - "Max Pressure算法能根据各相位排队数输出yes/no决策"
    - "支持最小/最大绿灯时间约束（必须延长/必须切换条件）"
    - "决策输出格式与模型输出对齐（字符串'yes'/'no'）"
  artifacts:
    - path: grpo/max_pressure.py
      provides: Max Pressure算法实现
      exports: ["MaxPressureConfig", "max_pressure_decision", "compute_phase_pressure"]
      min_lines: 80
    - path: grpo/config.py
      provides: MaxPressureConfig配置类
      contains: "class MaxPressureConfig"
  key_links:
    - from: grpo/max_pressure.py
      to: grpo/sumo_interface.py
      via: "复用SUMOInterface.get_valid_phases()获取相位min_dur/max_dur"
      pattern: "get_valid_phases"
---

## Objective

实现Max Pressure baseline算法，根据各相位的排队车辆数判断是否延长当前绿灯相位。Max Pressure是交通信号控制领域的经典算法，将作为GRPO训练中reward计算的baseline参考。

**Purpose:** 提供可靠的baseline决策算法，用于与模型输出比较评估训练效果

**Output:** grpo/max_pressure.py模块，包含MaxPressureConfig、compute_phase_pressure和max_pressure_decision函数

## Context

@/home/samuel/.claude/get-shit-done/workflows/execute-plan.md
@/home/samuel/.claude/get-shit-done/templates/summary.md

@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@grpo/sumo_interface.py
@grpo/config.py
@.planning/phases/01-grpo-core-infrastructure/01-03-SUMMARY.md

## Tasks

<task type="auto">
  <name>Task 1: 创建Max Pressure算法核心函数</name>
  <files>grpo/max_pressure.py</files>
  <action>
创建grpo/max_pressure.py模块，实现以下内容：

1. **MaxPressureConfig数据类**:
   - min_green_offset: 最小绿时间偏移（默认0，用于安全边界）
   - max_green_override: 是否允许覆盖最大绿时间（默认False）
   - pressure_threshold: 压力差阈值（默认0，当前相位>=其他相位时延长）

2. **compute_phase_pressure()函数**:
   - 输入：phase_queues (Dict[int, float], 相位ID到排队长度的映射)
   - 输出：Dict[int, float], 相位ID到压力值的映射
   - 使用标准Max Pressure公式：pressure = queue_count（简化版，只考虑上游排队）
   - 注：完整公式是upstream - downstream，但当前数据结构中只有avg_queue_veh

3. **max_pressure_decision()核心函数**:
   - 输入：
     * current_phase_id: int（当前相位ID）
     * phase_queues: Dict[int, float]（各相位排队数，键为phase_id）
     * green_elapsed: float（当前绿灯已持续时间，秒）
     * min_green: float（最小绿灯时间，秒）
     * max_green: float（最大绿灯时间，秒）
     * config: MaxPressureConfig（配置对象）
   - 输出：str，'yes'或'no'
   - 决策逻辑：
     a. 时间约束检查：
        - 如果green_elapsed < min_green: 必须返回'yes'（不能提前切换）
        - 如果green_elapsed >= max_green: 必须返回'no'（不能超时延长）
     b. Max Pressure决策：
        - 计算当前相位的压力：current_pressure = phase_queues[current_phase_id]
        - 找出其他相位的最大压力：max_other_pressure = max(phase_queues.values() excluding current)
        - 如果current_pressure >= max_other_pressure: 返回'yes'
        - 否则返回'no'

4. **max_pressure_decision_from_prompt()便捷函数**:
   - 从prompt JSON中提取所需信息（调用parse_prompt_for_decision_info）
   - 调用max_pressure_decision()进行决策
   - 便于直接用于reward计算

注意事项：
- 复用grpo/sumo_reward.py中的parse_prompt_for_decision_info()提取prompt信息
- 当前相位不存在于phase_queues中时，抛出ValueError
- 返回值严格为小写字符串'yes'或'no'
  </action>
  <verify>
  1. 检查文件存在且包含所有必需函数：
   python3 -c "from grpo.max_pressure import MaxPressureConfig, compute_phase_pressure, max_pressure_decision, max_pressure_decision_from_prompt; print('All imports OK')"

  2. 运行基本测试验证决策逻辑：
   python3 -c "
from grpo.max_pressure import compute_phase_pressure, max_pressure_decision, MaxPressureConfig

# 测试压力计算
queues = {0: 10.0, 1: 5.0, 2: 3.0}
pressures = compute_phase_pressure(queues)
assert pressures[0] == 10.0, 'Pressure calculation failed'
print('Pressure calculation: OK')

# 测试时间约束（小于最小绿必须延长）
decision = max_pressure_decision(0, queues, green_elapsed=5, min_green=10, max_green=60, config=MaxPressureConfig())
assert decision == 'yes', f'Min green constraint failed: got {decision}'
print('Min green constraint: OK')

# 测试时间约束（超过最大绿必须切换）
decision = max_pressure_decision(0, queues, green_elapsed=60, min_green=10, max_green=60, config=MaxPressureConfig())
assert decision == 'no', f'Max green constraint failed: got {decision}'
print('Max green constraint: OK')

# 测试Max Pressure决策（当前相位排队最大）
queues = {0: 10.0, 1: 5.0, 2: 3.0}
decision = max_pressure_decision(0, queues, green_elapsed=15, min_green=10, max_green=60, config=MaxPressureConfig())
assert decision == 'yes', f'Max pressure extend failed: got {decision}'
print('Max pressure extend: OK')

# 测试Max Pressure决策（其他相位排队更大）
queues = {0: 5.0, 1: 10.0, 2: 3.0}
decision = max_pressure_decision(0, queues, green_elapsed=15, min_green=10, max_green=60, config=MaxPressureConfig())
assert decision == 'no', f'Max pressure switch failed: got {decision}'
print('Max pressure switch: OK')

print('All tests passed!')
"
  </verify>
  <done>
Max Pressure算法实现完成，能够：
1. 根据各相位排队数计算压力值
2. 考虑最小/最大绿灯时间约束
3. 返回与模型输出对齐的'yes'/'no'决策
  </done>
</task>

<task type="auto">
  <name>Task 2: 更新模块导出和配置集成</name>
  <files>grpo/__init__.py grpo/config.py</files>
  <action>
1. 更新grpo/__init__.py，添加Max Pressure相关导出：
   - from grpo.max_pressure import MaxPressureConfig, max_pressure_decision, max_pressure_decision_from_prompt, compute_phase_pressure

2. 在grpo/config.py中添加MaxPressureConfig导入（可选，用于配置集成）：
   - 当前保持MaxPressureConfig在max_pressure.py中定义
   - 如果需要，在GRPOTrainingConfig中添加max_pressure: MaxPressureConfig字段（Phase 3可选）

注意事项：
- 确保导出与现有的reward函数风格一致
- max_pressure模块保持独立，便于未来在reward计算中使用
  </action>
  <verify>
python3 -c "from grpo import MaxPressureConfig, max_pressure_decision, max_pressure_decision_from_prompt, compute_phase_pressure; print('Module exports: OK')"
  </verify>
  <done>
模块导出更新完成，Max Pressure函数可通过grpo包直接导入
  </done>
</task>

<task type="auto">
  <name>Task 3: 添加batch决策函数</name>
  <files>grpo/max_pressure.py</files>
  <action>
在grpo/max_pressure.py中添加batch版本的决策函数：

1. **batch_max_pressure_decision()函数**:
   - 输入：
     * prompts: List[str]（prompt JSON字符串列表）
     * config: MaxPressureConfig（配置对象）
   - 输出：List[str]，决策列表（'yes'或'no'）
   - 实现：对每个prompt调用max_pressure_decision_from_prompt()
   - 用途：在reward计算中批量获取baseline决策

2. **compare_with_baseline()辅助函数**:
   - 输入：
     * model_decisions: List[str]（模型输出决策）
     * baseline_decisions: List[str]（Max Pressure决策）
   - 输出：List[bool]或accuracy统计
   - 实现：逐个比较，返回匹配结果
   - 用途：评估模型与baseline的一致性

注意事项：
- 保持与现有batch函数风格一致（如batch_format_reward）
- 错误处理：单个prompt解析失败时返回'no'（保守策略）
  </action>
  <verify>
python3 -c "
from grpo.max_pressure import batch_max_pressure_decision, compare_with_baseline

# 测试batch决策（需要真实prompt数据或mock）
# 基本导入测试
print('Batch functions imported: OK')

# 测试比较函数
model = ['yes', 'no', 'yes']
baseline = ['yes', 'yes', 'yes']
matches = compare_with_baseline(model, baseline)
assert sum(matches) == 2, f'Comparison failed: expected 2 matches, got {sum(matches)}'
print('Compare function: OK')

print('All batch tests passed!')
"
  </verify>
  <done>
batch决策函数实现完成，支持批量Max Pressure决策和baseline比较
  </done>
</task>

## Verification

整体验证：
1. 所有函数能正确导入
2. Max Pressure算法在各种边界条件下正确决策
3. 时间约束（最小/最大绿灯）正确应用
4. 批量处理功能正常

## Success Criteria

1. grpo/max_pressure.py文件包含所有必需函数
2. 算法在测试用例中正确输出yes/no决策
3. 时间约束（min/max green）正确限制决策范围
4. 模块导出更新，可通过grpo包导入

## Output

After completion, create `.planning/phases/02-max-pressure-config/02-01-SUMMARY.md`
