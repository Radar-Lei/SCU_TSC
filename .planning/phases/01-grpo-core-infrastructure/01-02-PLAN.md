---
phase: 01-grpo-core-infrastructure
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - grpo/reward.py
  - grpo/__init__.py
  - config/grpo_config.yaml
autonomous: true

must_haves:
  truths:
    - "format_reward_fn能够正确识别严格格式 `{'extend': 'yes'}` 或 `{'extend': 'no'}`，返回+1"
    - "format_reward_fn能够识别部分遵守格式（可通过正则提取yes/no），返回-0.5"
    - "format_reward_fn能够识别完全不遵守格式，返回-10"
    - "正则表达式可配置（通过配置文件）"
    - "函数返回 (reward: float, is_strict: bool) 元组"
  artifacts:
    - path: "grpo/reward.py"
      provides: "Reward函数模块"
      exports: ["format_reward_fn", "extract_decision", "FormatResult"]
    - path: "config/grpo_config.yaml"
      provides: "更新后的配置文件"
      contains: ["format_reward_strict", "format_reward_partial", "format_reward_invalid", "extract_regex"]
  key_links:
    - from: "grpo/training.py"
      to: "grpo/reward.py"
      via: "导入format_reward_fn"
      pattern: "from.*reward.*import.*format_reward_fn"
    - from: "grpo/reward.py"
      to: "config/grpo_config.yaml"
      via: "读取正则表达式和评分配置"
      pattern: "extract_regex|format_reward_strict"
---

<objective>
实现format_reward_fn，验证模型输出是否符合JSON格式要求，采用三级评分机制。

**Purpose**: 确保模型学习输出正确格式的JSON，这是有效进行TSC决策的前提。

**Output**:
- `grpo/reward.py`: Reward函数模块，包含format_reward_fn和辅助函数
- 更新`config/grpo_config.yaml`: 添加format reward相关配置
- 更新`grpo/__init__.py`: 导出reward函数

**评分机制**（根据CONTEXT.md决策）:
1. **严格format** → +1.0: 精确匹配 `{"extend": "yes"}` 或 `{"extend": "no"}`
2. **部分遵守format** → -0.5: 能通过正则提取yes/no（如带额外空格、换行）
3. **完全不遵守format** → -10.0: 无法提取决策或格式错误
</objective>

<execution_context>
@/home/samuel/.claude/get-shit-done/workflows/execute-plan.md
@/home/samuel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/REQUIREMENTS.md
@.planning/phases/01-grpo-core-infrastructure/01-CONTEXT.md
@grpo/config.py
</context>

<tasks>

<task type="auto">
  <name>任务1: 创建reward.py模块并实现format_reward_fn</name>
  <files>grpo/reward.py</files>
  <action>
创建 `grpo/reward.py`，实现format验证和评分函数：

**数据类**:
```python
@dataclass
class FormatResult:
    reward: float
    is_strict: bool
    is_partial: bool
    extracted_decision: Optional[str]  # "yes", "no", or None
```

**核心函数**:

1. `extract_decision(text: str, regex: str) -> Optional[str]`:
   - 使用正则表达式从文本中提取yes/no决策
   - 默认正则: `r'\{["\s]*extend["\s]*:\s*["\s]*(yes|no)["\s]*\}'`
   - 返回小写的 "yes" 或 "no"，或 None

2. `format_reward_fn(output: str, regex: str = None, strict_reward: float = 1.0, partial_reward: float = -0.5, invalid_reward: float = -10.0) -> FormatResult`:
   - **第一步**: 尝试 json.loads(output)
     - 成功且为字典且只有 "extend" 键且值为 "yes" 或 "no" → is_strict=True, reward=strict_reward
   - **第二步**: 如果不是严格格式，使用正则提取
     - 能提取到 yes/no → is_partial=True, reward=partial_reward
   - **第三步**: 都不成功 → reward=invalid_reward

3. `batch_format_reward(outputs: List[str], **kwargs) -> List[float]`:
   - 批量处理版本，供GRPOTrainer使用
   - 返回每个output的reward列表

**实现细节**:
- 使用 json.loads 进行严格验证
- 使用 re.search 提取决策
- 处理大小写不敏感（统一转为小写）
- 处理多余的空格、换行符
- 捕获所有异常（json.JSONDecodeError等）

**导入**:
```python
import json
import re
from typing import Optional, List
from dataclasses import dataclass
```
  </action>
  <verify>
```bash
# 测试函数可以导入
python3 -c "from grpo.reward import format_reward_fn, extract_decision, FormatResult; print('Import OK')"

# 测试严格格式
python3 -c "
from grpo.reward import format_reward_fn
result = format_reward_fn('{\"extend\": \"yes\"}')
print(f'Strict test: reward={result.reward}, is_strict={result.is_strict}')
assert result.reward == 1.0 and result.is_strict == True
"

# 测试部分格式
python3 -c "
from grpo.reward import format_reward_fn
result = format_reward_fn('{\"extend\": \"yes\"  }')
print(f'Partial test: reward={result.reward}, is_partial={result.is_partial}')
assert result.reward == -0.5 and result.is_partial == True
"

# 测试无效格式
python3 -c "
from grpo.reward import format_reward_fn
result = format_reward_fn('invalid output')
print(f'Invalid test: reward={result.reward}')
assert result.reward == -10.0
"
```
  </verify>
  <done>
format_reward_fn函数实现完成，能够正确识别三种格式的输出并返回相应的reward。
  </done>
</task>

<task type="auto">
  <name>任务2: 更新配置文件添加format reward参数</name>
  <files>config/grpo_config.yaml</files>
  <action>
在 `config/grpo_config.yaml` 中添加format reward相关配置：

```yaml
# Format reward配置
format_reward:
  strict: 1.0          # 严格格式奖励
  partial: -0.5        # 部分遵守格式惩罚
  invalid: -10.0       # 完全不遵守格式惩罚
  extract_regex: '\{["\s]*extend["\s]*:\s*["\s]*(yes|no)["\s]*\}'
```

更新 `grpo/config.py` 的 `GRPOTrainingConfig` 类：
- 添加嵌套的 FormatRewardConfig dataclass
- 在 GRPOTrainingConfig 中添加 format_reward: FormatRewardConfig 字段
- 更新 from_yaml() 方法解析嵌套配置
  </action>
  <verify>
```bash
# 检查配置文件更新
grep -A 5 "format_reward:" /home/samuel/SCU_TSC/config/grpo_config.yaml

# 检查配置类可以正确读取
python3 -c "
from grpo.config import GRPOTrainingConfig
config = GRPOTrainingConfig.from_yaml('config/grpo_config.yaml')
print(f'format_reward.strict={config.format_reward.strict}')
"
```
  </verify>
  <done>
配置文件更新完成，format reward参数可以被正确加载。
  </done>
</task>

<task type="auto">
  <name>任务3: 更新模块导出</name>
  <files>grpo/__init__.py</files>
  <action>
更新 `grpo/__init__.py`，添加reward函数的导出：

```python
from .reward import format_reward_fn, extract_decision, FormatResult
```

确保可以:
```python
from grpo import format_reward_fn, extract_decision, FormatResult
```
  </action>
  <verify>
```bash
python3 -c "from grpo import format_reward_fn, extract_decision, FormatResult; print('Exports OK')"
```
  </verify>
  <done>
reward函数可以从grpo包直接导入。
  </done>
</task>

</tasks>

<verification>
**整体验证**:
1. 三种格式的测试用例都通过
2. 正则表达式可以通过配置文件修改
3. 批量处理函数能正确处理列表输入
4. 配置文件参数能正确传递给函数

**测试用例**:
- 严格: `{"extend": "yes"}`, `{"extend": "no"}` → +1.0
- 部分: `{"extend": "yes"  }`, `{"extend":"yes"}`, `{ "extend" : "yes" }` → -0.5
- 无效: `invalid`, `{"action": "yes"}`, `I think yes` → -10.0
</verification>

<success_criteria>
1. `grpo/reward.py` 创建完成，包含所有必需函数
2. `config/grpo_config.yaml` 添加format_reward配置段
3. `grpo/config.py` 更新FormatRewardConfig配置类
4. 三种格式的测试用例全部通过
5. `from grpo import format_reward_fn` 导入成功
</success_criteria>

<output>
完成此计划后，创建 `.planning/phases/01-grpo-core-infrastructure/01-02-SUMMARY.md`，记录:
- format_reward_fn的实现逻辑
- 三级评分机制的测试结果
- 正则表达式的配置方式
</output>
