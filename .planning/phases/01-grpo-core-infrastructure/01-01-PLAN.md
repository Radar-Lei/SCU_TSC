---
phase: 01-grpo-core-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - config/grpo_config.yaml
  - grpo/training.py
  - grpo/__init__.py
  - grpo/config.py
autonomous: true

must_haves:
  truths:
    - "运行 `python grpo/training.py --config config/grpo_config.yaml` 能够启动GRPO训练"
    - "训练脚本能够加载SFT checkpoint作为起点（使用FastLanguageModel.from_pretrained）"
    - "GRPOTrainer配置正确，包含reward函数、生成参数、训练参数"
    - "数据加载器能够读取GRPO数据集并构建prompt（messages格式）"
    - "配置文件包含所有必需的超参数（model_path、learning_rate、batch_size等）"
  artifacts:
    - path: "config/grpo_config.yaml"
      provides: "GRPO训练配置文件"
      contains: ["model_path", "learning_rate", "batch_size", "num_generations", "temperature"]
    - path: "grpo/training.py"
      provides: "GRPO训练主脚本"
      exports: ["train_grpo", "load_grpo_dataset", "parse_args"]
    - path: "grpo/config.py"
      provides: "配置数据类"
      exports: ["GRPOTrainingConfig", "load_config"]
  key_links:
    - from: "grpo/training.py"
      to: "config/grpo_config.yaml"
      via: "load_config函数"
      pattern: "yaml\\.safe_load|GRPOTrainingConfig\\.from_yaml"
    - from: "grpo/training.py"
      to: "grpo/sft_training.py"
      via: "参考SFT训练的模型加载模式"
      pattern: "FastLanguageModel\\.from_pretrained"
    - from: "grpo/training.py"
      to: "data/grpo_datasets"
      via: "数据加载路径"
      pattern: "load.*dataset.*json"
---

<objective>
创建GRPO训练脚本框架，集成Unsloth和TRL的GRPOTrainer，实现配置文件管理和数据加载。

**Purpose**: 建立GRPO训练的基础架构，使训练过程可通过配置文件控制，能够从SFT模型继续训练。

**Output**:
- `grpo/training.py`: GRPO训练主脚本，包含train_grpo()函数
- `config/grpo_config.yaml`: 默认配置文件，包含所有超参数
- 更新`grpo/config.py`: 添加GRPOTrainingConfig配置类和load_config函数

**参考**:
- SFT训练脚本: `grpo/sft_training.py` (FastLanguageModel加载模式、训练参数配置)
- Unsloth GRPOTrainer: 已编译缓存 `unsloth_compiled_cache/UnslothGRPOTrainer.py`
</objective>

<execution_context>
@/home/samuel/.claude/get-shit-done/workflows/execute-plan.md
@/home/samuel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/REQUIREMENTS.md
@.planning/phases/01-grpo-core-infrastructure/01-CONTEXT.md
@grpo/sft_training.py
@grpo/config.py
@grpo/sumo_interface.py
@grpo/prompt_builder.py
</context>

<tasks>

<task type="auto">
  <name>任务1: 创建GRPO训练配置文件和数据类</name>
  <files>config/grpo_config.yaml, grpo/config.py</files>
  <action>
创建 `config/grpo_config.yaml` 包含以下配置项：

**模型配置**:
- model_path: SFT模型路径（默认: /home/samuel/SCU_TSC/model/sft_model）
- max_seq_length: 2048

**GRPO核心参数**:
- learning_rate: 1e-5
- batch_size: 2
- gradient_accumulation_steps: 4
- num_generations: 4（每个prompt生成多个候选response）
- temperature: 0.9
- kl_coeff: 0.1（KL散度系数）

**生成控制参数**:
- max_new_tokens: 50
- top_p: 0.9
- repetition_penalty: 1.0

**训练参数**:
- num_train_epochs: 3
- warmup_steps: 10
- logging_steps: 5
- save_steps: 50
- optim: adamw_8bit

**Reward权重**（预留，01-04实现）:
- format_weight: 1.0
- tsc_weight: 1.0

**SUMO仿真参数**（预留，01-03实现）:
- max_workers: 4
- extend_seconds: 5

**数据路径**:
- dataset_path: GRPO数据集路径

更新 `grpo/config.py`，添加 `GRPOTrainingConfig` dataclass：
- 使用 @dataclass 装饰器
- 包含所有YAML配置对应的字段
- 实现 from_yaml(cls, path) 类方法
- 实现 to_dict(self) 方法
- 添加参数验证逻辑（检查必需参数、范围）

**不要修改现有的GRPOConfig类**（用于数据生成），创建新类避免冲突。
  </action>
  <verify>
```bash
# 检查配置文件存在且包含必需字段
grep -E "model_path|learning_rate|batch_size|num_generations" /home/samuel/SCU_TSC/config/grpo_config.yaml

# 检查配置类可以正常导入和加载
python3 -c "from grpo.config import GRPOTrainingConfig; config = GRPOTrainingConfig.from_yaml('config/grpo_config.yaml'); print(config.model_path)"
```
  </verify>
  <done>
配置文件创建完成，GRPOTrainingConfig类能够正确解析YAML并验证参数。
  </done>
</task>

<task type="auto">
  <name>任务2: 创建GRPO训练脚本框架</name>
  <files>grpo/training.py</files>
  <action>
创建 `grpo/training.py`，参考 `grpo/sft_training.py` 的结构：

**必需的函数**:

1. `load_grpo_dataset(dataset_path: str) -> Dataset`:
   - 读取GRPO数据集JSON文件
   - 每条数据转换为TRL GRPOTrainer期望的格式
   - prompt转换为messages格式: `[{"role": "user", "content": SYSTEM_PROMPT + prompt}]`
   - 使用 datasets.Dataset.from_list()

2. `train_grpo(config: GRPOTrainingConfig)`:
   - 加载SFT模型: `FastLanguageModel.from_pretrained(config.model_path)`
   - 添加LoRA适配器（如果SFT模型未包含）
   - 加载reference model（用于KL散度计算）
   - 创建GRPOConfig（trl的配置类，注意区别于自己的配置类）
   - 创建GRPOTrainer（传入reward函数占位符）
   - 调用trainer.train()
   - 保存模型到output_dir

3. `parse_args()` 和 `main()`:
   - 支持 --config 参数指定配置文件
   - 支持命令行参数覆盖配置
   - 参数优先级: 命令行 > 配置文件 > 默认值

**导入依赖**:
```python
from unsloth import FastLanguageModel
from trl import GRPOTrainer, GRPOConfig
from transformers import TrainingArguments
from datasets import Dataset
```

**注意**: reward函数暂时使用占位符（返回固定值），在01-02和01-03中实现具体逻辑。

参考SFT训练的:
- 模型加载模式
- 训练参数配置（SFTConfig -> GRPOConfig）
- 日志和保存策略
  </action>
  <verify>
```bash
# 检查训练脚本可以导入和解析参数
python3 -c "from grpo.training import train_grpo, load_grpo_dataset, parse_args; print('Import successful')"

# 检查帮助信息可以正常显示
python3 grpo/training.py --help
```
  </verify>
  <done>
训练脚本创建完成，可以导入并解析配置，数据加载函数能正确转换数据格式。
  </done>
</task>

<task type="auto">
  <name>任务3: 更新grpo/__init__.py导出</name>
  <files>grpo/__init__.py</files>
  <action>
更新 `grpo/__init__.py`，添加新的导出:
- 从 training 导出 train_grpo, load_grpo_dataset
- 从 config 导出 GRPOTrainingConfig, load_config

确保模块可以正确导入:
```python
from grpo import train_grpo, load_grpo_dataset, GRPOTrainingConfig
```
  </action>
  <verify>
```bash
python3 -c "from grpo import train_grpo, load_grpo_dataset, GRPOTrainingConfig; print('Exports OK')"
```
  </verify>
  <done>
模块导出正确，可以直接从grpo包导入训练函数和配置类。
  </done>
</task>

</tasks>

<verification>
**整体验证**:
1. 配置文件包含所有必需参数
2. GRPOTrainingConfig类能正确解析YAML
3. 训练脚本可以导入并解析参数
4. 数据加载函数能正确转换GRPO数据集格式
5. 训练函数能加载SFT模型（不需要实际运行训练，只验证模型加载）

注意: 此计划只创建框架，不涉及reward函数实现（01-02和01-03）。
</verification>

<success_criteria>
1. `config/grpo_config.yaml` 文件存在，包含所有必需的超参数
2. `grpo/config.py` 新增 GRPOTrainingConfig 类，包含 from_yaml() 方法
3. `grpo/training.py` 创建完成，包含 train_grpo(), load_grpo_dataset(), parse_args(), main() 函数
4. `python grpo/training.py --help` 显示帮助信息
5. `from grpo import train_grpo, load_grpo_dataset, GRPOTrainingConfig` 导入成功
</success_criteria>

<output>
完成此计划后，创建 `.planning/phases/01-grpo-core-infrastructure/01-01-SUMMARY.md`，记录:
- 配置文件结构和参数
- 训练脚本框架结构
- 数据格式转换逻辑
- 与SFT训练的差异点
</output>
