---
phase: 05-max-pressure-baseline-integration
plan: 03
type: execute
wave: 2
depends_on: []
files_modified:
  - grpo/config.py
  - config/training_config.yaml
autonomous: true

must_haves:
  truths:
    - "GRPOTrainingConfig包含enable_baseline和baseline_config字段"
    - "training_config.yaml中reward.max_pressure.enabled激活"
    - "配置加载时正确解析baseline配置"
  artifacts:
    - path: "grpo/config.py"
      provides: "支持baseline配置的配置系统"
      exports: ["GRPOTrainingConfig", "MaxPressureConfig"]
      contains: "enable_baseline.*baseline_config"
    - path: "config/training_config.yaml"
      provides: "激活的baseline配置"
      contains: "reward.max_pressure.enabled.*true"
  key_links:
    - from: "config/training_config.yaml"
      to: "grpo/config.py"
      via: "YAML加载"
      pattern: "reward.*max_pressure"
    - from: "grpo/config.py"
      to: "grpo/max_pressure.py"
      via: "MaxPressureConfig导入"
      pattern: "MaxPressureConfig"
---

<objective>
激活baseline配置，添加enable_baseline_tracking参数

目的：在配置系统中激活Max Pressure baseline相关配置，支持通过配置文件控制baseline追踪行为
输出：扩展的配置类和激活的YAML配置
</objective>

<execution_context>
@/home/samuel/.claude/get-shit-done/workflows/execute-plan.md
@/home/samuel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-max-pressure-baseline-integration/05-RESEARCH.md
@.planning/v1-MILESTONE-AUDIT.md

@grpo/config.py
@grpo/max_pressure.py
@config/training_config.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: 扩展GRPOTrainingConfig添加baseline配置</name>
  <files>grpo/config.py</files>
  <action>
在GRPOTrainingConfig类中添加Max Pressure baseline配置字段：

1. 导入MaxPressureConfig（已存在于文件中）

2. 在GRPOTrainingConfig中添加两个新字段：
   - enable_baseline: bool = False
   - baseline_config: MaxPressureConfig = field(default_factory=MaxPressureConfig)

3. 在__post_init__()中添加配置一致性验证：
   - 如果enable_baseline=True且baseline_config为None，警告用户
   - 验证baseline_config字段类型

4. 在from_yaml()方法中添加baseline配置解析：
   - 从data中提取reward.max_pressure数据
   - 提取enabled字段作为enable_baseline值
   - 创建MaxPressureConfig实例作为baseline_config

注意：
- MaxPressureConfig已在文件中定义（line 430-434）
- 需要确保两个MaxPressureConfig定义一致（使用同一个）
- 保持向后兼容：enabled字段不存在时默认False
  </action>
  <verify>
grep -n "enable_baseline\|baseline_config" /home/samuel/SCU_TSC/grpo/config.py
python -c "from grpo.config import GRPOTrainingConfig; print(hasattr(GRPOTrainingConfig.__dataclass_fields__, 'enable_baseline'))"
  </verify>
  <done>
GRPOTrainingConfig包含enable_baseline和baseline_config字段，from_yaml正确解析配置
  </done>
</task>

<task type="auto">
  <name>Task 2: 激活training_config.yaml中baseline配置</name>
  <files>config/training_config.yaml</files>
  <action>
在training_config.yaml的reward.max_pressure部分添加enabled字段：

1. 修改reward.max_pressure配置段：
   ```yaml
   reward:
     max_pressure:
       enabled: true  # 新增：启用baseline追踪
       min_green_offset: 0.0
       max_green_override: false
       pressure_threshold: 0.0
   ```

2. 保持其他配置不变

注意：这是激活配置的关键步骤，enabled=true将启用baseline追踪功能。
  </action>
  <verify>
grep -A5 "reward:" /home/samuel/SCU_TSC/config/training_config.yaml | grep -A4 "max_pressure:"
yq '.reward.max_pressure.enabled' /home/samuel/SCU_TSC/config/training_config.yaml
  </verify>
  <done>
training_config.yaml中reward.max_pressure.enabled设置为true
  </done>
</task>

<task type="auto">
  <name>Task 3: 更新TrainingConfig.grpo属性传递baseline配置</name>
  <files>grpo/config.py</files>
  <action>
更新TrainingConfig类的grpo property，确保正确传递baseline配置：

1. 在grpo property返回的GRPOTrainingConfig中添加baseline字段：
   - 添加：enable_baseline=self.training.get('grpo', {}).get('enable_baseline', False)
   - 添加：baseline_config=self.reward.max_pressure（MaxPressureConfig实例）

2. 确保配置传递链完整：
   - training_config.yaml -> TrainingConfig -> GRPOTrainingConfig
   - reward.max_pressure.* -> baseline_config

注意：grpo property用于将TrainingConfig转换为GRPOTrainingConfig，需要包含所有GRPO训练所需的字段。
  </action>
  <verify>
python -c "from grpo.config import load_training_config; tc = load_training_config('config/training_config.yaml'); gc = tc.grpo; print(gc.enable_baseline); print(gc.baseline_config)"
  </verify>
  <done>
TrainingConfig.grpo property返回包含baseline配置的GRPOTrainingConfig实例
  </done>
</task>

</tasks>

<verification>
1. 检查GRPOTrainingConfig定义包含enable_baseline和baseline_config
2. 检查training_config.yaml中max_pressure.enabled=true
3. 运行python测试配置加载：python -c "from grpo.config import load_training_config; tc = load_training_config(); gc = tc.grpo; print(f'enable_baseline={gc.enable_baseline}')"
4. 验证baseline_config正确解析
</verification>

<success_criteria>
1. GRPOTrainingConfig包含enable_baseline字段（默认False）
2. GRPOTrainingConfig包含baseline_config字段（MaxPressureConfig实例）
3. training_config.yaml中reward.max_pressure.enabled=true
4. 配置加载后enable_baseline为True
</success_criteria>

<output>
After completion, create `.planning/phases/05-max-pressure-baseline-integration/05-03-SUMMARY.md`
</output>
