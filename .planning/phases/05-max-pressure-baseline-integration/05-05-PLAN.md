---
phase: 05-max-pressure-baseline-integration
plan: 05
type: execute
wave: 3
depends_on: ["05-01", "05-02", "05-03"]
files_modified:
  - tests/integration/test_integration.py
autonomous: true

must_haves:
  truths:
    - "集成测试验证完整训练流程包含baseline追踪"
    - "训练日志包含Baseline Accuracy输出"
    - "baseline追踪在GRPO训练中正常工作"
  artifacts:
    - path: "tests/integration/test_integration.py"
      provides: "baseline功能的集成测试"
      contains: "test.*baseline.*integration"
  key_links:
    - from: "tests/integration/test_integration.py"
      to: "grpo/training.py"
      via: "完整训练流程测试"
      pattern: "train_grpo\|create_reward_function"
    - from: "tests/integration/test_integration.py"
      to: "grpo/reward.py"
      via: "reward函数调用"
      pattern: "batch_compute_reward"
---

<objective>
编写集成测试，验证baseline追踪在完整训练流程中工作

目的：通过端到端集成测试验证Max Pressure baseline追踪在完整GRPO训练流程中正常工作
输出：扩展的test_integration.py测试文件
</objective>

<execution_context>
@/home/samuel/.claude/get-shit-done/workflows/execute-plan.md
@/home/samuel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-max-pressure-baseline-integration/05-RESEARCH.md
@.planning/v1-MILESTONE-AUDIT.md

@tests/integration/test_integration.py
@grpo/training.py
@grpo/reward.py
@.planning/phases/05-max-pressure-baseline-integration/05-01-SUMMARY.md
@.planning/phases/05-max-pressure-baseline-integration/05-02-SUMMARY.md
@.planning/phases/05-max-pressure-baseline-integration/05-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: 添加create_reward_function baseline集成测试</name>
  <files>tests/integration/test_integration.py</files>
  <action>
在test_integration.py中添加create_reward_function() baseline功能的集成测试：

1. 添加测试用例test_create_reward_function_with_baseline_tracking()：
   - 创建包含时间参数的小型测试数据集
   - 调用create_reward_function()，enable_baseline_tracking=True
   - 调用返回的reward_fn
   - 验证返回的rewards为列表
   - 验证标准输出包含"Baseline Accuracy"（使用capsys捕获）

2. 使用@pytest.fixture准备测试数据：
   - 小型数据集（5-10条）
   - 每条包含：prompt, state_file, current_green_elapsed, min_green, max_green
   - prompts使用真实的SUMO状态JSON格式

3. 验证baseline决策正确计算：
   - 检查打印的准确率在合理范围内（0-100%）
   - 检查匹配数与总计数的关系正确
  </action>
  <verify>
grep -n "test.*baseline.*tracking\|test_create_reward.*baseline" /home/samuel/SCU_TSC/tests/integration/test_integration.py
pytest tests/integration/test_integration.py -k baseline -v -m integration
  </verify>
  <done>
test_integration.py包含create_reward_function baseline测试，集成测试通过
  </done>
</task>

<task type="auto">
  <name>Task 2: 添加load_grpo_dataset时间保留测试</name>
  <files>tests/integration/test_integration.py</files>
  <action>
在test_integration.py中添加load_grpo_dataset()保留时间参数的集成测试：

1. 添加测试用例test_load_grpo_dataset_preserves_time_params()：
   - 创建测试JSON文件，包含时间参数字段
   - 调用load_grpo_dataset()
   - 验证返回的dataset包含current_green_elapsed列
   - 验证包含min_green列
   - 验证包含max_green列
   - 验证值正确（非None或与输入一致）

2. 添加测试用例test_load_grpo_dataset_backward_compatibility()：
   - 创建测试JSON文件，不包含时间参数字段
   - 调用load_grpo_dataset()
   - 验证函数不报错
   - 验证返回的dataset可用
  </action>
  <verify>
grep -n "test_load_grpo.*time\|test.*preserves" /home/samuel/SCU_TSC/tests/integration/test_integration.py
pytest tests/integration/test_integration.py -k "load_grpo" -v -m integration
  </verify>
  <done>
test_integration.py包含数据集加载时间参数保留测试
  </done>
</task>

<task type="auto">
  <name>Task 3: 添加配置加载baseline测试</name>
  <files>tests/integration/test_integration.py</files>
  <action>
在test_integration.py中添加配置加载baseline功能的集成测试：

1. 添加测试用例test_config_loads_baseline_settings()：
   - 创建临时YAML配置文件，包含reward.max_pressure.enabled=true
   - 调用load_training_config()
   - 验证返回的TrainingConfig.reward.max_pressure.enabled=True
   - 验证tc.grpo.enable_baseline=True（如果已实现）

2. 添加测试用例test_grpo_training_config_baseline_defaults()：
   - 测试GRPOTrainingConfig默认值
   - 验证enable_baseline默认为False
   - 验证baseline_config为MaxPressureConfig实例

3. 添加测试用例test_baseline_config_validation()：
   - 测试配置验证逻辑
   - 验证无效配置被正确处理
  </action>
  <verify>
grep -n "test_config.*baseline\|test_baseline.*config" /home/samuel/SCU_TSC/tests/integration/test_integration.py
pytest tests/integration/test_integration.py -k "config.*baseline" -v -m integration
  </verify>
  <done>
test_integration.py包含配置加载baseline测试
  </done>
</task>

<task type="auto">
  <name>Task 4: 更新端到端训练测试验证baseline</name>
  <files>tests/integration/test_integration.py</files>
  <action>
更新现有的端到端训练测试，验证baseline追踪功能：

1. 修改test_end_to_end_training_small_scale()（如果存在）：
   - 在训练配置中启用baseline（enable_baseline=True）
   - 在训练日志验证部分添加检查
   - 验证日志包含"Baseline Accuracy"输出
   - 验证准确率数值在合理范围内

2. 如果没有端到端测试，添加test_grpo_training_with_baseline()：
   - 使用小规模数据集（10条）
   - 使用少量训练步数（2-3步）
   - 启用baseline追踪
   - 验证训练完成
   - 验证日志包含baseline统计

注意：端到端测试需要完整的模型和SUMO环境，标记为@pytest.mark.integration
  </action>
  <verify>
grep -n "Baseline Accuracy\|baseline" /home/samuel/SCU_TSC/tests/integration/test_integration.py
pytest tests/integration/test_integration.py -k "end_to_end" -v -m integration
  </verify>
  <done>
端到端训练测试验证baseline追踪功能，检查训练日志中的Baseline Accuracy
  </done>
</task>

</tasks>

<verification>
1. 运行pytest tests/integration/test_integration.py -k baseline -v -m integration
2. 验证所有baseline集成测试通过
3. 运行完整集成测试套件确保无回归：pytest tests/integration/ -v -m integration
4. 检查测试日志包含Baseline Accuracy输出
5. 如果有Docker环境，运行./scripts/run_integration_test.sh验证
</verification>

<success_criteria>
1. test_integration.py包含至少4个baseline相关集成测试用例
2. 所有baseline集成测试通过
3. 端到端训练测试验证Baseline Accuracy输出
4. 现有集成测试无回归
</success_criteria>

<output>
After completion, create `.planning/phases/05-max-pressure-baseline-integration/05-05-SUMMARY.md`
</output>
