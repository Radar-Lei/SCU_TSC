---
phase: 05-max-pressure-baseline-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - grpo/reward.py
autonomous: true

must_haves:
  truths:
    - "Max Pressure决策函数在reward计算中被调用"
    - "batch_compute_reward()接受时间参数列表"
    - "baseline决策信息在返回值中提供"
  artifacts:
    - path: "grpo/reward.py"
      provides: "扩展的reward计算函数（支持baseline）"
      exports: ["compute_reward", "batch_compute_reward"]
      contains: "max_pressure_decision_from_prompt"
  key_links:
    - from: "grpo/reward.py"
      to: "grpo/max_pressure.py"
      via: "from .max_pressure import max_pressure_decision_from_prompt"
      pattern: "from .max_pressure import"
---

<objective>
扩展reward计算函数，添加Max Pressure baseline比较逻辑

目的：在reward计算层集成Max Pressure算法，使每个样本的评估都能与baseline决策进行比较
输出：扩展的compute_reward()和batch_compute_reward()函数，支持可选的baseline比较
</objective>

<execution_context>
@/home/samuel/.claude/get-shit-done/workflows/execute-plan.md
@/home/samuel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-max-pressure-baseline-integration/05-RESEARCH.md
@.planning/v1-MILESTONE-AUDIT.md

@grpo/reward.py
@grpo/max_pressure.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: 扩展compute_reward()添加baseline比较</name>
  <files>grpo/reward.py</files>
  <action>
在compute_reward()函数中添加Max Pressure baseline比较逻辑：

1. 添加可选参数：
   - green_elapsed: float = None
   - min_green: float = None
   - max_green: float = None
   - enable_baseline: bool = False
   - mp_config: Any = None

2. 在format_reward计算后、TSC reward计算前，添加baseline比较逻辑：
   - 从grpo.max_pressure导入max_pressure_decision_from_prompt和MaxPressureConfig
   - 当enable_baseline=True且所有时间参数非None时，调用max_pressure_decision_from_prompt()
   - 提取模型决策（format_result.extracted_decision）
   - 比较baseline决策与模型决策
   - 将baseline_info合并到返回的info_dict中

3. baseline_info格式：
   {
       "baseline_decision": "yes/no",
       "model_decision": "yes/no",
       "matches_baseline": True/False/None
   }

4. 错误处理：
   - 捕获ValueError, KeyError, json.JSONDecodeError
   - 失败时设置baseline_info = {"baseline_error": str(e)}

5. 保持向后兼容：
   - 所有新参数为可选
   - enable_baseline=False时保持原有行为
   - 时间参数为None时跳过baseline计算
  </action>
  <verify>
grep -n "max_pressure_decision_from_prompt" /home/samuel/SCU_TSC/grpo/reward.py
grep -n "baseline_decision" /home/samuel/SCU_TSC/grpo/reward.py
python -c "from grpo.reward import compute_reward; help(compute_reward)" | grep -E "(green_elapsed|enable_baseline)"
  </verify>
  <done>
compute_reward()函数接受baseline参数，当enable_baseline=True时调用Max Pressure算法进行比较，结果包含在返回值中
  </done>
</task>

<task type="auto">
  <name>Task 2: 扩展batch_compute_reward()支持baseline</name>
  <files>grpo/reward.py</files>
  <action>
在batch_compute_reward()函数中添加Max Pressure baseline批量处理：

1. 添加可选参数：
   - green_elapsed_list: List[float] = None
   - min_green_list: List[float] = None
   - max_green_list: List[float] = None
   - enable_baseline: bool = False
   - mp_config: Any = None

2. 在format_results计算后、TSC计算前，预计算baseline决策：
   - 导入batch_max_pressure_decision和MaxPressureConfig
   - 当enable_baseline=True且所有时间参数列表非None时，调用batch_max_pressure_decision()
   - 传递正确长度的参数（使用outputs长度截断）

3. 在计算统计信息时添加baseline匹配计数：
   - 从format_results中提取所有有效决策（extracted_decision非None）
   - 调用compare_with_baseline()比较
   - 统计匹配数量（sum(matches)）

4. 打印baseline统计信息：
   - 在现有统计输出后添加baseline准确率
   - 格式：print(f"  Baseline Accuracy: {accuracy:.2%} ({sum(matches)}/{len(matches)})")

5. 错误处理：
   - baseline计算失败时打印警告
   - 不中断reward计算流程

6. 注意：暂不扩展RewardStats dataclass，通过打印输出统计信息
  </action>
  <verify>
grep -n "batch_max_pressure_decision" /home/samuel/SCU_TSC/grpo/reward.py
grep -n "Baseline Accuracy" /home/samuel/SCU_TSC/grpo/reward.py
python -c "from grpo.reward import batch_compute_reward; help(batch_compute_reward)" | grep -E "(green_elapsed_list|enable_baseline)"
  </verify>
  <done>
batch_compute_reward()函数接受baseline参数，批量计算baseline决策，打印准确率统计
  </done>
</task>

</tasks>

<verification>
1. 检查reward.py导入了max_pressure模块
2. 检查compute_reward和batch_compute_reward签名包含新参数
3. 运行python -c "from grpo.reward import compute_reward, batch_compute_reward"验证导入无错误
4. 检查函数包含baseline_info相关代码
</verification>

<success_criteria>
1. compute_reward()函数签名包含enable_baseline等参数
2. batch_compute_reward()函数签名包含时间参数列表和enable_baseline
3. reward.py导入了max_pressure相关函数
4. 代码包含baseline比较逻辑和错误处理
</success_criteria>

<output>
After completion, create `.planning/phases/05-max-pressure-baseline-integration/05-01-SUMMARY.md`
</output>
