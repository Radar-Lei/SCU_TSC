---
phase: 05-max-pressure-baseline-integration
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - grpo/training.py
autonomous: true

must_haves:
  truths:
    - "训练脚本加载时间参数从dataset"
    - "create_reward_function()接受enable_baseline_tracking参数"
    - "训练日志显示baseline准确率统计"
  artifacts:
    - path: "grpo/training.py"
      provides: "支持baseline追踪的训练脚本"
      exports: ["create_reward_function", "load_grpo_dataset"]
      contains: "enable_baseline_tracking"
  key_links:
    - from: "grpo/training.py"
      to: "grpo/reward.py"
      via: "batch_compute_reward()调用"
      pattern: "batch_compute_reward.*enable_baseline"
    - from: "grpo/training.py"
      to: "grpo/max_pressure.py"
      via: "预计算baseline决策"
      pattern: "batch_max_pressure_decision"
---

<objective>
增强训练脚本，添加Max Pressure baseline统计追踪

目的：在训练层集成Max Pressure baseline，预计算baseline决策并追踪训练过程中模型相对于baseline的改进
输出：扩展的create_reward_function()和load_grpo_dataset()，支持baseline追踪
</objective>

<execution_context>
@/home/samuel/.claude/get-shit-done/workflows/execute-plan.md
@/home/samuel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-max-pressure-baseline-integration/05-RESEARCH.md
@.planning/v1-MILESTONE-AUDIT.md

@grpo/training.py
@grpo/reward.py
@grpo/max_pressure.py
@.planning/phases/05-max-pressure-baseline-integration/05-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: 修改load_grpo_dataset()保留时间参数</name>
  <files>grpo/training.py</files>
  <action>
修改load_grpo_dataset()函数，保留时间参数字段供baseline使用：

1. 在grpo_data.append()中添加三个字段：
   - "current_green_elapsed": item.get("current_green_elapsed", None)
   - "min_green": item.get("min_green", None)
   - "max_green": item.get("max_green", None)

2. 保持向后兼容：
   - 字段值为None时，baseline功能自动禁用
   - 旧数据集（无这些字段）仍可正常加载

3. 添加注释说明这些字段用于Max Pressure baseline计算

注意：这些字段在GRPO数据集中已存在（由dataset_generator.py生成），只是之前被丢弃了。
  </action>
  <verify>
grep -n "current_green_elapsed\|min_green\|max_green" /home/samuel/SCU_TSC/grpo/training.py
python -c "from grpo.training import load_grpo_dataset; import inspect; sig = inspect.signature(load_grpo_dataset); print('load_grpo_dataset保留时间参数')"
  </verify>
  <done>
load_grpo_dataset()返回的dataset包含current_green_elapsed, min_green, max_green字段
  </done>
</task>

<task type="auto">
  <name>Task 2: 扩展create_reward_function()添加baseline追踪</name>
  <files>grpo/training.py</files>
  <action>
扩展create_reward_function()函数，添加Max Pressure baseline统计追踪：

1. 添加函数参数：
   - enable_baseline_tracking: bool = False
   - mp_config: Any = None

2. 在函数开始处，预加载时间参数：
   green_elapsed_list = dataset.get("current_green_elapsed", [None] * len(dataset))
   min_green_list = dataset.get("min_green", [None] * len(dataset))
   max_green_list = dataset.get("max_green", [None] * len(dataset))

3. 预计算baseline决策（当enable_baseline_tracking=True时）：
   - 导入batch_max_pressure_decision和MaxPressureConfig
   - 使用dataset["prompt"], green_elapsed_list, min_green_list, max_green_list调用batch_max_pressure_decision()
   - 存储为闭包变量

4. 在reward_fn中传递时间参数给batch_compute_reward()：
   - 添加参数：green_elapsed_list=aligned_green_elapsed, min_green_list=aligned_min_green, max_green_list=aligned_max_green
   - 添加参数：enable_baseline=enable_baseline_tracking, mp_config=mp_config

5. 在统计信息打印部分添加baseline准确率输出（如果enable_baseline_tracking）：
   - 导入compare_with_baseline和compute_baseline_accuracy
   - 提取模型决策：[extract_decision(o) for o in outputs if extract_decision(o) is not None]
   - 计算准确率并打印：print(f"  Baseline Accuracy: {accuracy:.2%} ({sum(matches)}/{len(matches)})")

6. 错误处理：
   - baseline预计算失败时打印警告并禁用追踪
   - baseline比较失败时仅打印错误，不中断训练
  </action>
  <verify>
grep -n "enable_baseline_tracking" /home/samuel/SCU_TSC/grpo/training.py
grep -n "baseline_decisions\|Baseline Accuracy" /home/samuel/SCU_TSC/grpo/training.py
python -c "from grpo.training import create_reward_function; import inspect; sig = inspect.signature(create_reward_function); print('enable_baseline_tracking' in str(sig))"
  </verify>
  <done>
create_reward_function()接受enable_baseline_tracking参数，预计算baseline决策并在训练日志中显示准确率
  </done>
</task>

<task type="auto">
  <name>Task 3: 更新train_grpo()传递baseline配置</name>
  <files>grpo/training.py</files>
  <action>
更新train_grpo()函数，传递baseline配置给create_reward_function()：

1. 在配置打印部分添加baseline状态输出：
   - 检查config对象是否有enable_baseline属性
   - 如果有，打印：print(f"Baseline追踪: {'启用' if getattr(config, 'enable_baseline', False) else '禁用'}")
   - 如果启用且存在baseline_config，打印配置详情

2. 在调用create_reward_function()时传递baseline配置：
   - enable_baseline_tracking=getattr(config, 'enable_baseline', False)
   - mp_config=getattr(config, 'baseline_config', None)

注意：使用getattr确保向后兼容，旧配置对象没有这些属性时使用默认值。
  </action>
  <verify>
grep -n "Baseline追踪\|enable_baseline" /home/samuel/SCU_TSC/grpo/training.py
  </verify>
  <done>
train_grpo()检测并传递baseline配置，训练开始时显示baseline追踪状态
  </done>
</task>

</tasks>

<verification>
1. 检查training.py中的load_grpo_dataset包含时间参数字段
2. 检查create_reward_function签名包含enable_baseline_tracking
3. 检查train_grpo传递baseline配置
4. 运行python -c "from grpo.training import create_reward_function; import inspect; print(inspect.signature(create_reward_function))"
</verification>

<success_criteria>
1. load_grpo_dataset()保留时间参数
2. create_reward_function()接受enable_baseline_tracking参数
3. train_grpo()传递baseline配置给create_reward_function
4. 训练日志包含Baseline Accuracy输出
</success_criteria>

<output>
After completion, create `.planning/phases/05-max-pressure-baseline-integration/05-02-SUMMARY.md`
</output>
