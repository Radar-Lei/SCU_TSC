---
phase: 03-训练流程集成
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - grpo/validate_data.py
  - tests/test_validate_data.py
autonomous: true

must_haves:
  truths:
    - "运行python -m grpo.validate_data检查所有数据文件"
    - "验证失败时输出具体的错误信息（哪个文件、哪条数据、什么问题）"
    - "验证在几秒内完成（快速验证）"
    - "验证成功时不输出任何信息（静默成功）"
  artifacts:
    - path: "grpo/validate_data.py"
      provides: "数据验证脚本"
      min_lines: 150
    - path: "tests/test_validate_data.py"
      provides: "验证脚本的单元测试"
      min_lines: 50
  key_links:
    - from: "grpo/validate_data.py"
      to: "data/grpo_datasets"
      via: "JSON文件读取和验证"
      pattern: "json\\.load.*grpo_datasets"
    - from: "grpo/validate_data.py"
      to: "data/sft_datasets"
      via: "JSON文件读取和验证"
      pattern: "json\\.load.*sft_datasets"
    - from: "grpo/validate_data.py"
      to: "sumo_interface"
      via: "SUMO状态文件加载测试"
      pattern: "sumo_interface.*load_state"
---

<objective>
实现数据验证脚本，在训练前快速检查GRPO数据集格式、SUMO状态文件、SFT数据集和配置文件的正确性。

Purpose: 确保训练前数据质量，避免训练中途因数据问题失败，节省用户时间。
Output: grpo/validate_data.py验证脚本
</objective>

<execution_context>
@/home/samuel/.claude/get-shit-done/workflows/execute-plan.md
@/home/samuel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase Context
@.planning/phases/03-训练流程集成/03-CONTEXT.md

# Data Format Reference
@grpo/generate_grpo_dataset.py
@grpo/generate_sft_dataset.py
@grpo/sumo_interface.py
@config/training_config.yaml
</context>

<tasks>

<task type="auto">
  <name>实现GRPO数据集验证</name>
  <files>grpo/validate_data.py</files>
  <action>
创建grpo/validate_data.py，添加validate_grpo_dataset函数：

验证项：
1. 文件存在性：data/grpo_datasets/*/grpo_dataset.json存在
2. JSON格式：文件可解析为有效JSON
3. 必需字段：每条数据包含以下字段
   - id (str)
   - prompt (str, 非空)
   - scenario (str)
   - junction_id (str)
   - state_file (str, 路径存在)
4. 字段类型检查：各字段类型正确
5. 数据量检查：每个场景至少有10条数据

失败时输出格式：
```
[ERROR] GRPO数据集验证失败:
  - 场景 arterial4x4_1: 文件不存在
  - 场景 arterial4x4_2: 第5条数据缺少prompt字段
  - 场景 arterial4x4_3: state_file不存在: data/...
```

成功时不输出。
  </action>
  <verify>
运行python -m grpo.validate_data，使用有效和无效数据测试
  </verify>
  <done>
GRPO数据集验证正确检测格式错误和缺失字段
  </done>
</task>

<task type="auto">
  <name>实现SFT数据集验证</name>
  <files>grpo/validate_data.py</files>
  <action>
在grpo/validate_data.py中添加validate_sft_dataset函数：

验证项：
1. 文件存在性：data/sft_datasets/sft_dataset.json存在
2. JSON格式：文件可解析为有效JSON
3. 必需字段：每条数据包含
   - id (str)
   - messages (list, 非空)
   - scenario (str)
4. messages格式验证：
   - 至少3条消息（system, user, assistant）
   - system.role == "system"
   - user.role == "user"
   - assistant.role == "assistant"
   - assistant.content是有效JSON且格式为{"extend": "yes"|"no"}

失败时输出具体位置和问题，成功时不输出。
  </action>
  <verify>
生成SFT数据集后运行验证
  </verify>
  <done>
SFT数据集验证正确检测messages格式和assistant响应格式
  </done>
</task>

<task type="auto">
  <name>实现SUMO状态文件验证</name>
  <files>grpo/validate_data.py</files>
  <action>
在grpo/validate_data.py中添加validate_sumo_state_files函数：

验证策略（快速验证）：
1. 抽样验证：随机抽取10个state_file路径
2. 文件存在性：文件存在
3. XML格式：文件可解析为有效XML（使用ElementTree）
4. 根元素：根元素是<snapshot>

使用grpo.sumo_interface的load_state函数测试加载：
- 导入sumo_interface
- 对每个抽样文件尝试load_state
- 失败时记录文件名和错误原因

失败时输出：
```
[ERROR] SUMO状态文件验证失败:
  - data/state/arterial4x4_1_snapshot_100.xml: 加载失败: ...
```

成功时不输出。
  </action>
  <verify>
运行python -m grpo.validate_data --verify-sumo
  </verify>
  <done>
SUMO状态文件抽样验证能检测损坏的XML文件
  </done>
</task>

<task type="auto">
  <name>实现配置文件和系统依赖验证</name>
  <files>grpo/validate_data.py</files>
  <action>
在grpo/validate_data.py中添加validate_config_and_environment函数：

验证项：
1. 配置文件存在：
   - config/training_config.yaml存在
   - config/grpo_config.yaml存在（如果引用）
2. YAML格式：文件可解析
3. 必需配置项：
   - training.sft.model_name
   - training.grpo.model_path
   - paths.data_dir等关键路径
4. Python包导入测试：
   - 尝试导入torch, transformers, unsloth, trl
   - 失败时提示用户安装

5. SUMO环境：
   - SUMO_HOME环境变量存在
   - sumo命令可执行

失败时输出具体问题，成功时不输出。
  </action>
  <verify>
临时重命名一个必需的包目录（如torch），运行python -m grpo.validate_data --check-env，验证能检测到缺失包并输出错误信息；恢复后再次运行确认验证通过
  </verify>
  <done>
配置和依赖验证能检测缺失的包和错误配置
  </done>
</task>

<task type="auto">
  <name>实现CLI入口和错误汇总</name>
  <files>grpo/validate_data.py</files>
  <action>
在grpo/validate_data.py中添加main函数和CLI：

1. 添加argparse参数：
   --grpo-only: 仅验证GRPO数据集
   --sft-only: 仅验证SFT数据集
   --verify-sumo: 验证SUMO状态文件（抽样）
   --check-env: 检查配置和依赖
   --verbose: 显示详细进度信息

2. 默认行为：运行所有验证

3. 错误汇总：
   - 收集所有验证错误
   - 按类别分组输出
   - 返回非零退出码（发现错误时）

4. main函数使用try-except捕获意外错误

退出码：
- 0: 所有验证通过
- 1: 发现验证错误
- 2: 发生意外错误
  </action>
  <verify>
运行python -m grpo.validate_data验证各种组合
  </verify>
  <done>
CLI支持各种验证组合，返回正确的退出码
  </done>
</task>

</tasks>

<verification>
整体验证：
1. python -m grpo.validate_data验证所有数据
2. 验证失败时输出具体错误信息
3. 验证成功时不输出（静默）
4. 验证在几秒内完成
</verification>

<success_criteria>
1. GRPO数据集验证检测格式错误和缺失字段
2. SFT数据集验证检测messages格式错误
3. SUMO状态文件抽样验证能检测损坏文件
4. 配置和依赖验证能检测环境问题
5. CLI支持--grpo-only等参数
6. 返回正确的退出码
</success_criteria>

<output>
After completion, create `.planning/phases/03-训练流程集成/03-02-SUMMARY.md`
</output>
