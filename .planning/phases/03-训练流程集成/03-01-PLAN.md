---
phase: 03-训练流程集成
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - docker/publish.sh
autonomous: true

must_haves:
  truths:
    - "运行docker/publish.sh时显示动态进度指示器"
    - "任何步骤失败时脚本立即停止并显示红色错误信息"
    - "训练成功后显示最终模型路径、训练时间、数据集大小等关键信息"
    - "脚本开始时检查所有依赖（CUDA、SUMO、Python包）"
  artifacts:
    - path: "docker/publish.sh"
      provides: "四步训练流程执行脚本"
      min_lines: 150
  key_links:
    - from: "docker/publish.sh"
      to: "grpo.generate_grpo_dataset"
      via: "python -m grpo.generate_grpo_dataset"
      pattern: "python -m grpo\\.generate_grpo_dataset"
    - from: "docker/publish.sh"
      to: "grpo.sft_training"
      via: "python -m grpo.sft_training"
      pattern: "python -m grpo\\.sft_training"
    - from: "docker/publish.sh"
      to: "grpo.training"
      via: "python -m grpo.training"
      pattern: "python -m grpo\\.training"
---

<objective>
完善docker/publish.sh脚本，使其具备现代化的CI/CD脚本特性：动态进度显示、失败快速停止、依赖检查、训练摘要输出。

Purpose: 确保训练流程可靠、清晰、用户友好，任何失败都能被及时发现和报告。
Output: 改进后的docker/publish.sh脚本
</objective>

<execution_context>
@/home/samuel/.claude/get-shit-done/workflows/execute-plan.md
@/home/samuel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase Context
@.planning/phases/03-训练流程集成/03-CONTEXT.md

# Existing Script
@docker/publish.sh
@config/training_config.yaml
</context>

<tasks>

<task type="auto">
  <name>实现依赖检查函数</name>
  <files>docker/publish.sh</files>
  <action>
在docker/publish.sh中添加check_dependencies函数，在训练开始前检查：
- CUDA可用性（nvidia-smi或/usr/local/cuda存在）
- SUMO安装（sumo命令或SUMO_HOME环境变量）
- Python包（torch, transformers, unsloth, trl）

检查失败时输出错误信息到stderr并退出。错误信息格式：
```
[ERROR] 依赖检查失败: <具体原因>
请确保所有依赖已安装。
```

使用红色ANSI代码（\033[0;31m）显示错误，\033[0m重置颜色。
  </action>
  <verify>
运行docker/publish.sh，确保依赖检查在训练前执行
  </verify>
  <done>
依赖缺失时脚本立即停止并显示红色错误信息
  </done>
</task>

<task type="auto">
  <name>实现动态进度指示器</name>
  <files>docker/publish.sh</files>
  <action>
添加spinner函数显示动态进度指示器。实现方式：
- 定义show_spinner函数，使用循环的字符（| / - \）显示旋转效果
- 在每个步骤开始时调用，步骤结束时停止
- 步骤名称格式："[Step N/4] 步骤名称..."
- 使用\r返回行首覆盖输出实现动画效果

四步流程：
1. "[Step 1/4] 生成GRPO数据集..."
2. "[Step 2/4] 生成SFT数据集..."
3. "[Step 3/4] SFT训练..."
4. "[Step 4/4] GRPO训练..."
  </action>
  <verify>
运行脚本时能看到每个步骤的动态进度指示
  </verify>
  <done>
每个步骤显示旋转动画，步骤完成后显示✓标记
  </done>
</task>

<task type="auto">
  <name>实现失败检测和错误处理</name>
  <files>docker/publish.sh</files>
  <action>
修改容器的-c命令，添加set -e和每个步骤的错误捕获：

1. 每个步骤包装在子shell中：
```bash
if (
    set -e
    echo "[Step 1/4] 生成GRPO数据集..."
    ${GRPO_GENERATE_CMD}
); then
    echo "✓ Step 1/4 完成"
else
    echo "\033[0;31m[ERROR] Step 1/4 失败: GRPO数据生成\033[0m" >&2
    echo "请查看日志: ${LOG_FILE}" >&2
    exit 1
fi
```

2. 任何步骤失败时：
   - 输出红色错误信息到stderr
   - 显示日志文件路径
   - 立即退出（不执行后续步骤）

3. 容器退出代码正确传播到主机
  </action>
  <verify>
故意制造一个失败（如错误的数据路径），验证脚本立即停止
  </verify>
  <done>
步骤失败时显示红色错误并停止，不继续执行后续步骤
  </done>
</task>

<task type="auto">
  <name>实现训练摘要输出</name>
  <files>docker/publish.sh</files>
  <action>
在训练流程成功完成后，添加训练摘要输出：

1. 收集以下信息：
   - 训练开始时间（START_TIME变量）
   - 训练结束时间（END_TIME变量）
   - SFT模型路径（outputs/YYYY-MM-DD_sft/）
   - GRPO模型路径（outputs/YYYY-MM-DD_grpo/）
   - GRPO数据集大小（data/grpo_datasets/*/grpo_dataset.json行数）
   - SFT数据集大小（data/sft_datasets/sft_dataset.json行数）

2. 格式化输出：
```
==========================================
训练完成！
==========================================
训练时间: HH:MM:SS
GRPO数据集: N 条
SFT数据集: N 条
SFT模型: outputs/YYYY-MM-DD_sft/
GRPO模型: outputs/YYYY-MM-DD_grpo/
==========================================
```

3. 时间计算使用date命令和算术运算
  </action>
  <verify>
运行完整训练后检查摘要输出
  </verify>
  <done>
训练成功后显示包含模型路径、数据集大小、训练时间的摘要
  </done>
</task>

</tasks>

<verification>
整体验证：
1. 运行./docker/publish.sh能看到每个步骤的进度指示
2. 任何步骤失败时脚本立即停止并显示错误信息
3. 训练成功后显示包含模型路径和关键指标的摘要
</verification>

<success_criteria>
1. 运行docker/publish.sh显示动态进度指示器（spinner + ✓）
2. 步骤失败时输出红色错误信息并立即停止
3. 训练完成后输出包含模型路径、数据集大小、训练时间的摘要
4. 脚本开始时检查依赖（CUDA、SUMO、Python包）
</success_criteria>

<output>
After completion, create `.planning/phases/03-训练流程集成/03-01-SUMMARY.md`
</output>
