---
phase: 03-训练流程集成
plan: 03
type: execute
wave: 2
depends_on: [03-01, 03-02]
files_modified:
  - docker/publish.sh
  - grpo/validate_data.py
autonomous: true

must_haves:
  truths:
    - "运行docker/publish.sh时自动在训练前执行数据验证"
    - "数据验证失败时训练流程不开始，立即退出"
    - "验证失败时显示验证错误信息（从validate_data.py输出）"
    - "验证成功后继续执行四步训练流程"
  artifacts:
    - path: "docker/publish.sh"
      provides: "集成验证的训练脚本"
      contains: "validate_data"
  key_links:
    - from: "docker/publish.sh"
      to: "grpo.validate_data"
      via: "训练前调用验证脚本"
      pattern: "python -m grpo\\.validate_data"
    - from: "grpo.validate_data"
      to: "training pipeline"
      via: "验证通过后允许训练"
      pattern: "exit 0"
---

<objective>
将数据验证步骤集成到docker/publish.sh训练流程中，确保只有数据验证通过后才执行四步训练流程。

Purpose: 在训练前确保数据质量，避免训练中途因数据问题失败浪费时间。
Output: 集成验证的docker/publish.sh脚本
</object>

<execution_context>
@/home/samuel/.claude/get-shit-done/workflows/execute-plan.md
@/home/samuel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase Context
@.planning/phases/03-训练流程集成/03-CONTEXT.md

# Previous Plans
@.planning/phases/03-训练流程集成/03-01-PLAN.md
@.planning/phases/03-训练流程集成/03-02-PLAN.md

# Files to Modify
@docker/publish.sh
@grpo/validate_data.py
</context>

<tasks>

<task type="auto">
  <name>在publish.sh中添加验证步骤</name>
  <files>docker/publish.sh</files>
  <action>
在docker/publish.sh的容器命令中添加验证步骤：

1. 在四步训练流程之前添加验证步骤：
```bash
echo '[Step 0/4] 验证数据...'
if (
    set -e
    python -m grpo.validate_data --verbose
); then
    echo "✓ 数据验证通过"
else
    echo "\033[0;31m[ERROR] 数据验证失败，终止训练\033[0m" >&2
    echo "请修复数据问题后重试" >&2
    exit 1
fi
```

2. 更新步骤编号：
   - Step 0/4: 数据验证（新增）
   - Step 1/4: 生成GRPO数据集（原Step 1）
   - Step 2/4: 生成SFT数据集（原Step 2）
   - Step 3/4: SFT训练（原Step 3）
   - Step 4/4: GRPO训练（原Step 4）

3. 验证失败时的错误处理：
   - 显示红色错误信息
   - 提示用户修复数据
   - 立即退出（不执行任何训练步骤）
  </action>
  <verify>
运行docker/publish.sh，验证步骤在训练前执行
  </verify>
  <done>
数据验证失败时训练流程不启动
  </done>
</task>

<task type="auto">
  <name>优化验证脚本的容器环境兼容性</name>
  <files>grpo/validate_data.py</files>
  <action>
在grpo/validate_data.py中添加容器环境适配：

1. 路径适配：
   - 检测是否在容器内运行（/proc/1/cgroup包含docker或lxc）
   - 容器内使用绝对路径/home/samuel/SCU_TSC
   - 主机上使用PROJECT_DIR环境变量

2. 错误输出适配：
   - 容器内使用stderr输出错误
   --verbose时显示详细信息到stdout

3. 退出码确保正确传播：
   - 验证失败时返回1
   - 捕获所有异常并返回2
   - 不使用sys.exit()之外的退出方式

4. 添加--container-mode参数：
   - 显式指定容器模式
   - 容器模式下路径自动调整
  </action>
  <verify>
在容器内运行python -m grpo.validate_data --container-mode
  </verify>
  <done>
验证脚本在容器内正确执行，路径和错误输出正确
  </done>
</task>

<task type="auto">
  <name>添加验证跳过选项</name>
  <files>docker/publish.sh</files>
  <action>
在docker/publish.sh中添加SKIP_VALIDATION环境变量支持：

1. 检查环境变量：
```bash
# 数据验证步骤（可跳过）
if [[ "${SKIP_VALIDATION:-0}" != "1" ]]; then
    echo '[Step 0/5] 验证数据...'
    if (
        set -e
        python -m grpo.validate_data --verbose
    ); then
        echo "✓ 数据验证通过"
    else
        echo "\033[0;31m[ERROR] 数据验证失败，终止训练\033[0m" >&2
        echo "提示: 使用 SKIP_VALIDATION=1 跳过验证（不推荐）" >&2
        exit 1
    fi
else
    echo "[WARNING] 跳过数据验证"
fi
```

2. 在脚本开头的环境变量说明中添加：
```
# 配置参数（通过环境变量）：
#   SKIP_VALIDATION - 跳过数据验证 (默认: 0)
```

3. 步骤编号根据是否跳过调整：
   - 跳过验证：Step 1/4 到 Step 4/4
   - 不跳过：Step 0/5 到 Step 4/5
  </action>
  <verify>
运行SKIP_VALIDATION=1 ./docker/publish.sh，跳过验证
  </verify>
  <done>
SKIP_VALIDATION=1时跳过验证步骤
  </done>
</task>

<task type="auto">
  <name>更新训练摘要包含验证结果</name>
  <files>docker/publish.sh</files>
  <action>
在训练摘要中添加验证结果信息：

1. 收集验证结果：
   - 验证是否通过（VALIDATION_PASSED变量）
   - 验证耗时（VALIDATION_TIME变量）

2. 在训练摘要中显示：
```
==========================================
训练完成！
==========================================
数据验证: ✓ 通过 (X秒)
训练时间: HH:MM:SS
GRPO数据集: N 条
SFT数据集: N 条
SFT模型: outputs/YYYY-MM-DD_sft/
GRPO模型: outputs/YYYY-MM-DD_grpo/
==========================================
```

3. 如果跳过验证，显示：
```
数据验证: ⊘ 跳过
```
  </action>
  <verify>
运行完整训练后检查摘要中的验证信息
  </verify>
  <done>
训练摘要包含验证结果和耗时
  </done>
</task>

</tasks>

<verification>
整体验证：
1. docker/publish.sh在训练前自动执行数据验证
2. 验证失败时训练流程不启动，显示错误信息
3. 验证通过后正常执行四步训练
4. SKIP_VALIDATION=1可以跳过验证
5. 训练摘要包含验证结果
</verification>

<success_criteria>
1. 运行docker/publish.sh时自动执行数据验证（Step 0/5）
2. 验证失败时立即退出并显示错误信息
3. 验证通过后正常执行四步训练流程
4. SKIP_VALIDATION=1时跳过验证步骤
5. 训练摘要包含验证状态
</success_criteria>

<output>
After completion, create `.planning/phases/03-训练流程集成/03-03-SUMMARY.md`
</output>
