# Phase 1: 数据生成架构重构 - Context

**Gathered:** 2026-02-03
**Status:** Ready for planning

<domain>
## Phase Boundary

建立正确的离线数据生成流程,生成包含双动作仿真结果的四元组数据集。通过SUMO状态保存/加载机制,从同一状态分叉执行延长(action=0)和切换(action=1)两个仿真分支,记录为(queue, next_queue_0, next_queue_1, metadata)格式的训练数据。支持多场景并行生成,使用端口池避免SUMO实例冲突。

</domain>

<decisions>
## Implementation Decisions

### 状态保存/加载机制
- **快照时机:** 仅在决策时刻(每5秒)保存快照,数据量最小
- **一致性校验:** 轻量校验 - 仅验证核心指标(排队长度、绿灯相位)是否一致
- **失败处理:** 快照保存/加载失败时跳过整个场景,记录错误日志但不阻塞其他场景
- **存储位置:** 使用临时文件(/tmp),每次生成都重新建立,避免磁盘积累

### 双动作分支执行
- **执行方式:** 顺序执行 - 先执行action=0分支,完成后从同一快照加载执行action=1分支
- **仿真时长:** 每个分支固定仿真5秒(与决策间隔一致)
- **结果收集:** 仅收集分支结束时的最终排队长度,不记录中间状态
- **失败处理:** 任一分支仿真失败则丢弃整个四元组数据点,确保数据完整性

### 数据格式和存储
- **metadata字段:** 最小集 - 仅包含基本信息(crossing_id, timestamp, phase_id)
- **文件格式:** JSONL格式(.jsonl),每行一条四元组数据
- **文件组织:** 按场景分文件(scene_001.jsonl, scene_002.jsonl...),便于按场景管理和调试
- **数据验证:** 语义校验 - 检查数值合理性(排队非负、next_queue_0/1差异明显),早期发现仿真问题

### 并行化和资源管理
- **并行策略:** 场景级并行 - 同时启动N个场景生成,每个场景使用独立SUMO实例
- **端口管理:** 动态扫描可用端口,实时分配给SUMO实例(避免固定端口池的限制)
- **并发控制:** 自适应并发 - 基于CPU/内存使用率动态调整并行场景数
- **错误恢复:** 隔离失败 - 单场景失败不影响其他场景,记录错误并继续

### Claude's Discretion
- 具体的快照文件命名规范
- 端口扫描的范围和算法细节
- 自适应并发的具体阈值(CPU/内存百分比)
- 错误日志的详细程度和格式

</decisions>

<specifics>
## Specific Ideas

- 参考现有代码中的checkpoint机制,但需要验证随机数生成器和车辆插入计划是否被正确保存
- Docker环境下并行SUMO实例的端口分配需要压力测试,确保不会冲突
- 数据生成完成后需要统计覆盖度(不同时段、不同路口、不同流量密度的分布)

</specifics>

<deferred>
## Deferred Ideas

无 - 讨论聚焦于Phase 1的数据生成架构,未涉及Phase 2的Reward计算或Phase 3的训练流程

</deferred>

---

*Phase: 01-数据生成架构重构*
*Context gathered: 2026-02-03*
