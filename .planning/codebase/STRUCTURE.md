# Codebase Structure

**Analysis Date:** 2025-02-03

## Directory Layout

```
/home/samuel/SCU_TSC/
├── grpo/                    # GRPO training and data generation module
│   ├── __init__.py         # Module exports with lazy loading
│   ├── config.py           # All configuration classes
│   ├── training.py         # GRPO training entry point
│   ├── sft_training.py     # SFT training entry point
│   ├── reward.py           # Format reward + reward chain
│   ├── sumo_reward.py      # SUMO-based TSC reward calculation
│   ├── max_pressure.py     # Max Pressure baseline algorithm
│   ├── sumo_interface.py   # SUMO TraCI abstraction
│   ├── dataset_generator.py # Core data generation logic
│   ├── prompt_builder.py   # Prompt JSON construction
│   ├── generate_grpo_dataset.py # Single scenario data gen
│   ├── generate_sft_dataset.py  # SFT dataset builder
│   ├── parallel_runner.py  # Multi-scenario parallel data gen
│   └── validate_data.py    # Dataset validation utilities
├── sumo_simulation/        # Legacy SUMO simulator module
│   ├── sumo_simulator.py   # Full-featured simulator class
│   ├── pyproject.toml      # Python project metadata
│   ├── environments/       # SUMO scenario directories (90+)
│   │   ├── arterial4x4_90/  # Example scenario
│   │   │   ├── *.sumocfg   # SUMO configuration
│   │   │   ├── *.net.xml   # Road network
│   │   │   └── ...
│   │   ├── arterial4x4_91/
│   │   ├── chengdu/
│   │   └── ...
│   └── .venv/              # Virtual environment
├── config/                 # Configuration files
│   ├── training_config.yaml # Central training configuration
│   └── read_config.py      # Config extraction utility
├── data/                   # Training data storage
│   ├── grpo_datasets/      # GRPO training data by scenario
│   │   ├── arterial4x4_90/
│   │   │   └── grpo_dataset.json
│   │   ├── arterial4x4_91/
│   │   │   └── grpo_dataset.json
│   │   └── generation_summary.json
│   └── sft_datasets/       # SFT format learning data
│       └── sft_dataset.json
├── model/                  # Trained models storage
│   ├── models/             # Downloaded base models
│   │   └── unsloth/
│   │       └── Qwen2___5-0___5B-Instruct/
│   ├── sft_model/          # SFT-trained model + checkpoints
│   │   ├── checkpoint-150/
│   │   ├── checkpoint-200/
│   │   ├── merged/         # Inference-ready merged model
│   │   └── config files
│   └── grpo_model/         # GRPO-trained model + checkpoints
│       └── checkpoint-50/
├── unsloth_compiled_cache/ # Unsloth-compiled trainer classes
│   ├── UnslothGRPOTrainer.py
│   ├── UnslothSFTTrainer.py
│   └── ... (other trainers)
├── .planning/              # GSD planning artifacts
│   └── codebase/           # Codebase analysis documents
├── rou_month_generator.py  # Route month generation utility
├── convert_to_gguf.py      # Model format conversion utility
└── test_stratified_split.py # Dataset splitting test
```

## Directory Purposes

**grpo/:**
- Purpose: Core training and data generation module
- Contains: All ML training logic, reward calculation, SUMO interface, dataset building
- Key files: `training.py`, `sft_training.py`, `reward.py`, `sumo_interface.py`, `dataset_generator.py`

**sumo_simulation/:**
- Purpose: SUMO traffic simulation scenarios and legacy simulator
- Contains: 90+ scenario directories (arterial4x4_90-100, chengdu), original SUMOSimulator class
- Key files: `sumo_simulator.py` (legacy but comprehensive), `environments/*/*.sumocfg`

**config/:**
- Purpose: Centralized configuration management
- Contains: YAML config files, config reading utilities
- Key files: `training_config.yaml` (single source of truth), `read_config.py`

**data/:**
- Purpose: Training datasets (generated by data pipeline)
- Contains: GRPO datasets by scenario, SFT format learning dataset
- Key files: `grpo_datasets/*/grpo_dataset.json`, `sft_datasets/sft_dataset.json`

**model/:**
- Purpose: Model checkpoints and base models
- Contains: Downloaded HuggingFace models, SFT/GRPO trained models, merged inference models
- Key files: `sft_model/merged/`, `grpo_model/checkpoint-*/`

**unsloth_compiled_cache/:**
- Purpose: Cached Unsloth-compiled TRL trainer classes (auto-generated)
- Contains: Compiled Python modules for faster training startup
- Generated: Yes, Committed: Yes

## Key File Locations

**Entry Points:**
- `/home/samuel/SCU_TSC/grpo/sft_training.py`: SFT format learning training
- `/home/samuel/SCU_TSC/grpo/training.py`: GRPO reinforcement learning training
- `/home/samuel/SCU_TSC/grpo/generate_grpo_dataset.py`: Single scenario data generation
- `/home/samuel/SCU_TSC/grpo/parallel_runner.py`: Multi-scenario parallel data generation
- `/home/samuel/SCU_TSC/sumo_simulation/sumo_simulator.py`: Direct SUMO simulation control

**Configuration:**
- `/home/samuel/SCU_TSC/config/training_config.yaml`: Central configuration (training, simulation, reward, paths)
- `/home/samuel/SCU_TSC/grpo/config.py`: Configuration dataclasses and YAML loading
- `/home/samuel/SCU_TSC/config/read_config.py`: CLI utility for config extraction

**Core Logic:**
- `/home/samuel/SCU_TSC/grpo/sumo_interface.py`: SUMO TraCI abstraction (PhaseInfo, SUMOInterface)
- `/home/samuel/SCU_TSC/grpo/reward.py`: Format validation and reward chain
- `/home/samuel/SCU_TSC/grpo/sumo_reward.py`: SUMO-based TSC reward (ParallelSUMORewardCalculator)
- `/home/samuel/SCU_TSC/grpo/max_pressure.py`: Max Pressure baseline algorithm
- `/home/samuel/SCU_TSC/grpo/dataset_generator.py`: Data collection loop, GRPODataEntry
- `/home/samuel/SCU_TSC/grpo/prompt_builder.py`: Prompt JSON construction

**Testing:**
- `/home/samuel/SCU_TSC/grpo/validate_data.py`: Dataset validation utilities
- `/home/samuel/SCU_TSC/test_stratified_split.py`: Stratified split testing

## Naming Conventions

**Files:**
- Training scripts: `{method}_training.py` (e.g., `sft_training.py`, `training.py`)
- Data generators: `generate_{dataset}_dataset.py` (e.g., `generate_grpo_dataset.py`)
- Utility modules: `{module}.py` (e.g., `reward.py`, `config.py`, `prompt_builder.py`)
- Test scripts: `test_{feature}.py` or `validate_{resource}.py`

**Directories:**
- Scenarios: Descriptive names like `arterial4x4_{id}`, `chengdu`
- Data: `{dataset_type}_datasets/{scenario}/`
- Models: `{training_method}_model/` (e.g., `sft_model/`, `grpo_model/`)

**Classes:**
- Config classes: `{Name}Config` (e.g., `GRPOConfig`, `MaxPressureConfig`)
- Result/data classes: `{Name}Result` or `{Name}Entry` (e.g., `TSCResult`, `GRPODataEntry`)
- Main components: `{Name}Generator`, `{Name}Calculator`, `{Name}Interface` (e.g., `GRPODatasetGenerator`, `ParallelSUMORewardCalculator`, `SUMOInterface`)

**Functions:**
- Training: `train_{method}()` (e.g., `train_sft()`, `train_grpo()`)
- Reward: `{name}_reward_fn()` or `compute_{name}_reward()` (e.g., `format_reward_fn()`, `tsc_reward_fn()`)
- Data operations: `load_{dataset}()`, `generate_{data}()`, `build_{artifact}()` (e.g., `load_grpo_dataset()`, `build_extend_decision_prompt()`)
- Decisions: `{algorithm}_decision()` (e.g., `max_pressure_decision()`)

**Constants:**
- UPPERCASE for module-level constants: `SYSTEM_PROMPT`, `DEFAULT_CONFIG`

## Where to Add New Code

**New Feature (Reward Function):**
- Implementation: `/home/samuel/SCU_TSC/grpo/reward.py` (add new reward function)
- Config: `/home/samuel/SCU_TSC/grpo/config.py` (add config dataclass)
- Registration: Update `RewardChainConfig` in `config.py` and `batch_compute_reward()` in `reward.py`

**New Component/Module (e.g., New Baseline Algorithm):**
- Implementation: `/home/samuel/SCU_TSC/grpo/{new_algorithm}.py`
- Export: Add to `/home/samuel/SCU_TSC/grpo/__init__.py` exports
- Integration: Import and use in `training.py` or `reward.py`

**New SUMO Scenario:**
- Location: `/home/samuel/SCU_TSC/sumo_simulation/environments/{scenario_name}/`
- Required files: `{scenario_name}.sumocfg`, `{scenario_name}.net.xml`
- Data generation: Will be auto-detected by `parallel_runner.py` or specified via `--env` flag

**Utilities:**
- Shared helpers: `/home/samuel/SCU_TSC/grpo/{utility_name}.py`
- CLI scripts: `/home/samuel/SCU_TSC/{script_name}.py` (project root)

**Configuration:**
- Training parameters: Edit `/home/samuel/SCU_TSC/config/training_config.yaml`
- New config sections: Add to YAML, create dataclass in `/home/samuel/SCU_TSC/grpo/config.py`

## Special Directories

**unsloth_compiled_cache/:**
- Purpose: Cached Unsloth-compiled TRL trainer classes for faster startup
- Generated: Yes (auto-generated by Unsloth)
- Committed: Yes (for reproducibility)
- Do not edit manually

**sumo_simulation/.venv/:**
- Purpose: Virtual environment for sumo_simulation module
- Generated: Yes
- Committed: No (should be in .gitignore)
- Recreate with: `python -m venv .venv && source .venv/bin/activate`

**model/models/unsloth/:**
- Purpose: Downloaded base models from HuggingFace
- Generated: Yes (downloaded on first training run)
- Committed: No (too large, auto-downloadable)
- Models: `Qwen2___5-0___5B-Instruct/` (and others)

**data/grpo_datasets/*/states/:**
- Purpose: SUMO simulation state files (XML) for reward calculation
- Generated: Yes (during data generation)
- Committed: Yes (required for reward calculation)
- Format: `state_{tl_id}_{time}_{count}.xml`

**.planning/codebase/:**
- Purpose: GSD (Generate Skeleton Development) planning documents
- Generated: Yes (by codebase mapper agent)
- Committed: Yes
- Documents: ARCHITECTURE.md, STRUCTURE.md, STACK.md, INTEGRATIONS.md, CONVENTIONS.md, TESTING.md, CONCERNS.md

---

*Structure analysis: 2025-02-03*
